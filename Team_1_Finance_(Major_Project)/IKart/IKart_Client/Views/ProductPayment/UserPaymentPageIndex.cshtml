@using IKart_Shared.DTOs.Payment
@model List<UserPaymentDto>

@{
    ViewBag.Title = "Your Payments";
    Layout = "~/Views/Shared/_UserLayout.cshtml";
}

<h2>Your Payments</h2>

<div class="container">
    @foreach (var payment in Model)
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
                <h5>Payment ID: @payment.PaymentId</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered mb-4">
                    <thead class="table-light">
                        <tr>
                            <th>Product</th>
                            <th>Card Type</th>
                            <th>Total Amount</th>
                            <th>Payment Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>@payment.ProductName</td>
                            <td>@(string.IsNullOrEmpty(payment.CardType) ? "-" : payment.CardType)</td>
                            <td>₹@payment.TotalAmount</td>
                            <td>@payment.PaymentDate.ToShortDateString()</td>
                            <td>
                                @if (payment.Status.ToLower() == "paid")
                                {
                                    <span class="badge bg-success">Paid</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark">Pending</span>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>

                @if (payment.TenureMonths > 1 && payment.Installments != null && payment.Installments.Any())
                {
                    <h6>EMI Details</h6>
                    <p><strong>Tenure:</strong> @payment.TenureMonths months</p>
                    <p><strong>Monthly EMI:</strong> ₹@payment.EMIAmount</p>

                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Installment ID</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var inst in payment.Installments)
                            {
                                <tr>
                                    <td>@inst.InstallmentId</td>
                                    <td>@inst.DueDate.ToShortDateString()</td>
                                    <td>₹@inst.Amount</td>
                                    <td>
                                        @if (inst.IsPaid)
                                        {
                                            <span class="badge bg-success">Paid</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!inst.IsPaid)
                                        {
                                            <a href="@Url.Action("InstallmentRazorpay", "ProductPayment", new { installmentId = inst.InstallmentId, paymentId = payment.PaymentId })" class="btn btn-warning btn-sm">Pay</a>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success">Paid</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    }
</div>
